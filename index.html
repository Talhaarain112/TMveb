<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
<title>TMveb</title>
<style>
/* All CSS is the same, no changes needed here */
:root {
--primary-color: #4f46e5; --primary-hover-color: #4338ca; --secondary-color: #10b981; --secondary-hover-color: #059669;
--accent-color: #f59e0b; --background-color: #f9fafb; --card-bg: #ffffff; --text-color-dark: #1f2937; --text-color-medium: #4b5563;
--text-color-light: #9ca3af; --border-color: #e5e7eb; --danger-color: #ef4444; --success-color: #10b981; --font-family: 'Inter', sans-serif;
--box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px -1px rgba(0, 0, 0, 0.05); --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
--border-radius: 0.5rem; --header-height: 65px;
}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
*, *::before, *::after { box-sizing: border-box; }
body { font-family: var(--font-family); margin: 0; background-color: var(--background-color); color: var(--text-color-medium); line-height: 1.5; font-size: 15px; font-weight: 400; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; transition: padding-left 0.3s ease; }
#auth-view { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; background-color: #E0E7FF; }
.auth-container { max-width: 400px; width: 100%; }
.auth-card { background-color: var(--card-bg); padding: 30px 35px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); border: 1px solid var(--border-color); }
.auth-header { text-align: center; margin-bottom: 25px; }
.auth-header .logo { font-size: 1.6rem; font-weight: 600; color: var(--primary-color); margin-bottom: 8px; }
.auth-header p { font-size: 0.9em; color: var(--text-color-light); margin: 0; font-weight: 300; }
.auth-card h2 { font-size: 1.25rem; font-weight: 500; color: var(--text-color-dark); margin: 0 0 20px 0; text-align: left; }
.form-group { margin-bottom: 15px; }
label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.8em; color: var(--text-color-medium); }
input[type="text"], input[type="email"], input[type="password"], input[type="number"], select { display: block; width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 0.9em; font-weight: 400; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
input:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15); outline: none; }
input.error { border-color: var(--danger-color); box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15); }
.error-message { color: var(--danger-color); font-size: 0.75em; margin-top: 4px; display: none; }
.forgot-password-link { display: block; text-align: right; font-size: 0.75em; color: var(--primary-color); text-decoration: none; margin-top: -8px; margin-bottom: 15px; font-weight: 400; } .forgot-password-link:hover { text-decoration: underline; }
.btn-submit { display: block; width: 100%; padding: 12px; font-size: 0.95em; font-weight: 500; color: white; background-color: var(--primary-color); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; margin-top: 20px; } .btn-submit:hover { background-color: var(--primary-hover-color); }
.btn-submit:disabled { background-color: #9ca3af; cursor: not-allowed; }
.auth-switch { margin-top: 20px; text-align: center; font-size: 0.85em; color: var(--text-color-light); }
.auth-switch a { color: var(--primary-color); text-decoration: none; font-weight: 500; } .auth-switch a:hover { text-decoration: underline; }
#login-card, #signup-card, #forgot-card { display: none; }
#app-view { display: none; padding-top: var(--header-height); }
#sidenav { height: 100%; width: 250px; position: fixed; z-index: 200; top: 0; left: 0; background-color: var(--card-bg); border-right: 1px solid var(--border-color); overflow-x: hidden; transform: translateX(-100%); transition: transform 0.3s ease-in-out; padding-top: 20px; }
#sidenav.open { transform: translateX(0); }
.sidenav-header { padding: 10px 20px; font-size: 1.25rem; font-weight: 600; color: var(--primary-color); margin-bottom: 20px; }
#sidenav a { padding: 12px 20px; text-decoration: none; font-size: 0.95rem; color: var(--text-color-medium); display: flex; align-items: center; gap: 15px; transition: background-color 0.2s, color 0.2s; }
#sidenav a:hover, #sidenav a.active { background-color: #eef2ff; color: var(--primary-color); font-weight: 500; }
#sidenav a svg { width: 20px; height: 20px; fill: currentColor; }
#sidenav-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.4); z-index: 150; }
#app-header { background-color: var(--card-bg); height: var(--header-height); border-bottom: 1px solid var(--border-color); box-shadow: var(--box-shadow); padding: 0 20px; display: flex; align-items: center; justify-content: space-between; position: fixed; top: 0; left: 0; width: 100%; z-index: 100; }
.header-left { display: flex; align-items: center; gap: 15px; }
#menu-toggle-btn { background: none; border: none; cursor: pointer; padding: 5px; color: var(--text-color-dark); }
#menu-toggle-btn svg { width: 24px; height: 24px; }
.header-brand { font-size: 1.15em; font-weight: 600; color: var(--primary-color); text-decoration: none; }
.header-right { display: flex; align-items: center; gap: 15px; }
.header-icon-btn { position: relative; background: none; border: none; cursor: pointer; padding: 5px; color: var(--text-color-dark); }
.header-icon-btn svg { width: 22px; height: 22px; }
.notification-badge { position: absolute; top: 0px; right: 0px; width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; border: 2px solid var(--card-bg); display: none; }
.content-page { display: none; }
.content-page.active { display: block; }
#app-content { padding: 20px; max-width: 700px; margin: 15px auto; }
.placeholder-content { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 40px; text-align: center; border: 1px solid var(--border-color); }
.placeholder-content h1 { color: var(--text-color-dark); font-weight: 500; }
.placeholder-content p { color: var(--text-color-medium); }
.balance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
.balance-card { color: white; padding: 15px 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); text-align: center; }
.balance-card.main { background-color: var(--primary-color); }
.balance-card.deposit { background-color: var(--secondary-color); }
.balance-card .balance-label { font-size: 0.8em; color: rgba(255, 255, 255, 0.8); margin-bottom: 4px; font-weight: 400; text-transform: uppercase; letter-spacing: 0.8px; }
.balance-card .balance-value { font-size: 1.8em; font-weight: 600; line-height: 1.2; }
.full-stat-card { background-color: var(--card-bg); padding: 24px 28px; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-shadow: var(--box-shadow); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
.full-stat-info { display: flex; align-items: center; gap: 12px; }
.full-stat-emoji { font-size: 1.8rem; line-height: 1; }
.full-stat-label { font-size: 1rem; color: var(--text-color-medium); font-weight: 500; }
.full-stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
.action-list { background-color: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--box-shadow); overflow: hidden; border: 1px solid var(--border-color); }
.action-list-item { display: flex; align-items: center; padding: 14px 18px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.15s ease; text-decoration: none; color: inherit; }
.action-list-item:last-child { border-bottom: none; }
.action-list-item:hover { background-color: #F9FAFB; }
.action-list-icon { flex-shrink: 0; width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
.action-list-icon svg { width: 18px; height: 18px; fill: white; }
.action-list-item.deposit .action-list-icon { background-color: var(--success-color); }
.action-list-item.withdraw .action-list-icon { background-color: var(--danger-color); }
.action-list-item.profile .action-list-icon { background-color: var(--primary-color); }
.action-list-info h2 { font-size: 0.95rem; margin: 0 0 3px 0; font-weight: 500; color: var(--text-color-dark); }
.action-list-info p { font-size: 0.8rem; color: var(--text-color-light); margin: 0; line-height: 1.4; font-weight: 400; }
.action-list-arrow { margin-left: auto; color: var(--text-color-light); font-size: 1.1em; }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.7); z-index: 1000; justify-content: center; align-items: center; padding: 15px; animation: fadeIn 0.2s ease-out; }
.modal-content { background-color: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow-lg); max-width: 480px; width: 100%; position: relative; animation: slideIn 0.25s ease-out; }
.modal-close { position: absolute; top: 8px; right: 8px; font-size: 1.5em; line-height: 1; border: none; background: none; color: var(--text-color-light); cursor: pointer; padding: 5px; } .modal-close:hover { color: var(--text-color-dark); }
.modal-content h3 { margin-top: 0; margin-bottom: 15px; font-weight: 500; font-size: 1.1rem; color: var(--primary-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px; }
.modal-content p, .modal-content .notice { font-size: 0.85em; color: var(--text-color-light); margin-bottom: 15px; font-weight: 400; line-height: 1.5; }
.modal-content .notice { background-color: #FEFBEB; color: #B45309; padding: 10px; border-radius: 4px; border: 1px solid #FDE68A; }
.modal-content .form-group label { font-size: 0.8em; font-weight: 500; color: var(--text-color-medium); display: block; margin-bottom: 5px; }
.modal-content input[type="text"], .modal-content input[type="number"], .modal-content select { padding: 9px 12px; font-size: 0.9em; border: 1px solid var(--border-color); border-radius: var(--border-radius); width: 100%; margin-bottom: 15px; font-weight: 400; }
.modal-content input:focus, .modal-content select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.15); outline: none; }
.modal-content .btn-group { display: flex; gap: 10px; margin-top: 15px; }
.modal-content .btn { padding: 9px 16px; font-size: 0.9em; font-weight: 500; }
.modal-content .btn-primary { background-color: var(--primary-color); color: white; } .modal-content .btn-primary:hover { background-color: var(--primary-hover-color); }
.modal-content .btn-secondary { background-color: var(--border-color); color: var(--text-color-medium); } .modal-content .btn-secondary:hover { background-color: #D1D5DB; }
.modal-content code { background-color: #F3F4F6; padding: 2px 5px; border-radius: 4px; font-family: monospace; font-size: 0.9em; color: var(--primary-color); display: inline-block; margin-top: 5px; word-break: break-all; }
.input-group { display: flex; }
.input-group input { border-top-right-radius: 0; border-bottom-right-radius: 0; flex-grow: 1; }
.input-group button { border-top-left-radius: 0; border-bottom-left-radius: 0; background-color: var(--primary-color); color: white; border: 1px solid var(--primary-color); padding: 0 12px; font-size: 0.8em; cursor: pointer; flex-shrink: 0; }
.input-group button:hover { background-color: var(--primary-hover-color); }
.table-responsive { overflow-x: auto; margin-top: 10px; border: 1px solid var(--border-color); border-radius: var(--border-radius); background: var(--card-bg); }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 10px 12px; text-align: left; vertical-align: middle; border-bottom: 1px solid var(--border-color); font-size: 0.85em; font-weight: 400; }
th { background-color: #F9FAFB; font-weight: 500; color: var(--text-color-light); font-size: 0.75em; text-transform: uppercase; letter-spacing: 0.5px; }
tbody tr:last-child td { border-bottom: none; }
tbody tr:hover { background-color: #f8fafc; }
td.-wrap { white-space: normal; }
.profile-info dt { font-size: 0.8em; color: var(--text-color-light); margin-bottom: 2px; font-weight: 500; }
.profile-info dd { font-size: 0.95em; color: var(--text-color-dark); margin-left: 0; margin-bottom: 10px; font-weight: 400; word-break: break-all;}
#notifications-list .notification-item { padding: 12px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em; }
#notifications-list .notification-item:last-child { border-bottom: none; }
#notifications-list .notification-item p { margin: 0; color: var(--text-color-medium); line-height: 1.4; }
#notifications-list .notification-item .timestamp { font-size: 0.75em; color: var(--text-color-light); margin-top: 4px; }
#notifications-list .no-notifications { color: var(--text-color-light); font-size: 0.9em; text-align: center; padding: 20px 0; }
.ad-card, .plan-card { background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--box-shadow); display: flex; flex-direction: column; }
.ad-card h3, .plan-card h3 { margin: 0 0 10px 0; font-size: 1.1rem; font-weight: 600; color: var(--text-color-dark); }
.ad-card p, .plan-card p { margin: 0 0 15px 0; font-size: 0.9rem; color: var(--text-color-medium); flex-grow: 1; }
.plan-details, .ad-details { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-top: 10px; border-top: 1px solid var(--border-color); }
.plan-detail-item, .ad-detail-item { text-align: center; flex: 1; } /* flex: 1 for equal spacing */
.plan-detail-item .label, .ad-detail-item .label { font-size: 0.75rem; color: var(--text-color-light); text-transform: uppercase; }
.plan-detail-item .value, .ad-detail-item .value { font-size: 1rem; font-weight: 600; color: var(--text-color-dark); }
.plan-card .price { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; }
.btn-action { display: block; width: 100%; padding: 10px; font-size: 0.9em; font-weight: 500; color: white; background-color: var(--secondary-color); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; text-align: center; margin-top: auto; }
.btn-action:hover { background-color: var(--secondary-hover-color); }
.btn-action:disabled { background-color: #9ca3af; cursor: not-allowed; }
.plan-card .btn-action { background-color: var(--primary-color); }
.plan-card .btn-action:hover { background-color: var(--primary-hover-color); }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideIn { from { transform: translateY(-15px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
@media (max-width: 768px) { #sidenav { width: 220px; } }
</style>
</head>
<body>

<div id="auth-view">
    <!-- Auth HTML is unchanged -->
    <div class="auth-container">
        <div id="login-card" class="auth-card">
            <div class="auth-header"> <div class="logo">TMveb</div> <p>welcome back! please login.</p> </div>
            <form id="login-form" onsubmit="handleLogin(event)">
            <div class="form-group"> <label for="login-email">email</label> <input type="email" id="login-email" required> </div>
            <div class="form-group"> <label for="login-password">password</label> <input type="password" id="login-password" required> <div id="login-error" class="error-message">Invalid email or password.</div> </div>
            <a href="#" class="forgot-password-link" onclick="showAuthPage('forgot-card'); return false;">forgot password?</a>
            <button type="submit" class="btn-submit">login</button>
            </form>
            <div class="auth-switch"> new here? <a href="#" onclick="showAuthPage('signup-card'); return false;">create an account</a> </div>
        </div>
        <div id="signup-card" class="auth-card" style="display: none;">
            <div class="auth-header"> <div class="logo">TMveb</div> <p>create your new account.</p> </div>
            <form id="signup-form" onsubmit="handleSignup(event)">
            <div class="form-group"> <label for="signup-username">username</label> <input type="text" id="signup-username" required> </div>
            <div class="form-group"> <label for="signup-email">email address</label> <input type="email" id="signup-email" required> <div id="signup-email-error" class="error-message">This email is already registered.</div> </div>
            <div class="form-group"> <label for="signup-password">password (6-12 characters)</label> <input type="password" id="signup-password" required> <div id="signup-password-error" class="error-message">Password must be 6-12 characters long.</div> </div>
            <div class="form-group"> <label for="signup-referral">referral code (optional)</label> <input type="text" id="signup-referral"> </div>
            <button type="submit" class="btn-submit">sign up</button>
            </form>
            <div class="auth-switch"> already have an account? <a href="#" onclick="showAuthPage('login-card'); return false;">login instead</a> </div>
        </div>
        <div id="forgot-card" class="auth-card" style="display: none;">
            <div class="auth-header"> <div class="logo">TMveb</div> <p>reset your password.</p> </div>
            <h2>Forgot Password</h2>
            <form id="forgot-form" onsubmit="handleForgotPassword(event)">
            <div class="form-group">
            <label for="forgot-email">Enter your email address</label>
            <input type="email" id="forgot-email" required placeholder="you@example.com">
            <div id="forgot-email-error" class="error-message">Email not found or error sending.</div>
            </div>
            <p style="font-size: 0.8em; color: var(--text-color-light); text-align: left;">We'll send a password reset link to your email.</p>
            <button type="submit" class="btn-submit">Send Reset Link</button>
            </form>
            <div class="auth-switch"> Remember password? <a href="#" onclick="showAuthPage('login-card'); return false;">Back to Login</a> </div>
        </div>
    </div>
</div>

<div id="app-view">
    <!-- App View HTML is unchanged -->
    <div id="sidenav">
        <div class="sidenav-header">TMveb Menu</div>
        <a href="#dashboard-page" class="nav-link active" data-page="dashboard-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 13v8h8v-8h-8zM3 21h8v-8H3v8zM3 3v8h8V3H3zm13.66-1.31L11 7.34 16.66 13l5.66-5.66-5.66-5.65z"/></svg>Dashboard</a>
        <a href="#wallet-page" class="nav-link" data-page="wallet-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>Wallet</a>
        <a href="#ads-page" class="nav-link" data-page="ads-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.5 4c.83 0 1.5.67 1.5 1.5v13c0 .83-.67 1.5-1.5 1.5H15v-5h2.5l.37-2.99h-2.87V9.02c0-.87.24-1.46 1.49-1.46H18.5V4.99c-.32-.04-.65-.06-1-.06-2.03 0-3.44 1.24-3.44 3.53V10H11v3h3v5H3.5c-.83 0-1.5-.67-1.5-1.5v-13C2 4.67 2.67 4 3.5 4h17z"/></svg>Ads</a>
        <a href="#plans-page" class="nav-link" data-page="plans-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>Plans</a>
        <a href="#my-team-page" class="nav-link" data-page="my-team-page"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>My Team</a>
        <a href="#" id="sidenav-logout"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 13v-2h-5v-2h5V7l5 5-5 5zm-8-3H3v2h5v-2zM5 3h14c1.1 0 2 .9 2 2v2h-2V5H5v14h14v-2h2v2c0 1.1-.9 2-2 2H5c-1.1 0-2-.9-2-2V5c0-1.1.9-2 2-2z"></path></svg>Logout</a>
    </div>
    <div id="sidenav-overlay"></div>
    <header id="app-header">
        <div class="header-left">
            <button id="menu-toggle-btn" title="Open Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button>
            <div class="header-brand">Dashboard</div>
        </div>
        <div class="header-right">
            <button class="header-icon-btn" title="Notifications" onclick="openModal('notifications-modal')">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path></svg>
                <div id="notification-badge" class="notification-badge"></div>
            </button>
            <a href="#" class="action-list-item profile" onclick="openModal('profile-modal')" style="padding:0; border:none; background:none;">
                <div class="action-list-icon" style="margin-right:0; background-color:var(--primary-color);">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                </div>
            </a>
        </div>
    </header>
    <main>
        <div id="dashboard-page" class="content-page active">
            <div id="app-content">
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">💰</span><div class="full-stat-label">Main Balance</div></div>
                    <div class="full-stat-value" id="dashboard-main-balance">0.00 Usdt</div>
                </div>
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">📥</span><div class="full-stat-label">Deposit Balance</div></div>
                    <div class="full-stat-value" id="dashboard-deposit-balance">0.00 Usdt</div>
                </div>
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">☀️</span><div class="full-stat-label">Today Earning</div></div>
                    <div class="full-stat-value" id="dashboard-today-earning">0.00 Usdt</div>
                </div>
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">🗓️</span><div class="full-stat-label">Last Week Earning</div></div>
                    <div class="full-stat-value" id="dashboard-last-week-earning">0.00 Usdt</div>
                </div>
                <div class="full-stat-card">
                    <div class="full-stat-info"><span class="full-stat-emoji">🏆</span><div class="full-stat-label">Total Earning</div></div>
                    <div class="full-stat-value" id="dashboard-total-earning">0.00 Usdt</div>
                </div>
            </div>
        </div>
        <div id="wallet-page" class="content-page">
            <div id="app-content">
                <div class="action-list">
                    <a href="#" class="action-list-item deposit" onclick="openModal('deposit-modal')">
                        <div class="action-list-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"></path></svg> </div>
                        <div class="action-list-info"> <h2>deposit</h2> <p>add funds via available networks.</p> </div>
                        <div class="action-list-arrow">›</div>
                    </a>
                    <a href="#" class="action-list-item withdraw" onclick="openModal('withdraw-modal')">
                        <div class="action-list-icon"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 12v-7h14v7h2V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v7h2zm7 3.67L19.59 11.09 21 12.5l-9 9-9-9 1.41-1.41L11 15.67V7h2v8.67z"></path></svg> </div>
                        <div class="action-list-info"> <h2>withdraw</h2> <p>receive within 3 days.</p> </div>
                        <div class="action-list-arrow">›</div>
                    </a>
                </div>
            </div>
        </div>
        <div id="ads-page" class="content-page">
            <div id="app-content">
                <div id="ads-container"></div>
            </div>
        </div>
        <div id="plans-page" class="content-page">
            <div id="app-content">
                <div id="plans-container"></div>
            </div>
        </div>
        <div id="my-team-page" class="content-page">
            <div id="app-content">
                <div class="form-group">
                    <label>Your Referral Link</label>
                    <div class="input-group">
                        <input type="text" id="page-referral-link" value="Loading..." readonly style="background:#f3f4f6;">
                        <button onclick="copyToClipboard(document.getElementById('page-referral-link').value)">Copy</button>
                    </div>
                </div>
                <h3 style="font-weight: 500; font-size: 1.1rem; margin-top: 30px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Referred Members</h3>
                <div class="table-responsive">
                    <table>
                        <thead> <tr> <th>Username</th> <th class="wrap">Email</th> <th>Total Deposit (USDT)</th> </tr> </thead>
                        <tbody id="team-members-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>
    <!-- All Modals are unchanged -->
    <div id="deposit-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('deposit-modal')">×</button>
            <h3>deposit usdt</h3>
            <p>minimum deposit: <strong id="deposit-min-text">10</strong><strong> Usdt</strong></p>
            <div id="deposit-wallets-container" style="margin-bottom: 20px;">
                <p>Loading available addresses...</p>
            </div>
            <form id="deposit-form" onsubmit="handleDepositSubmit(event)">
                <div class="form-group"> <label for="deposit-method-select">payment sent from</label> <select id="deposit-method-select" required> <option value="">-- select network --</option> <option value="TRC20">TRC20</option> <option value="BEP20">BEP20</option> </select> </div>
                <div class="form-group"> <label for="deposit-account-number">your wallet address (sender)</label> <input type="text" id="deposit-account-number" placeholder="" required> </div>
                <div class="form-group"> <label for="deposit-amount-input">amount sent (usdt)</label> <input type="number" id="deposit-amount-input" step="1" min="10" required> </div>
                <div class="form-group"> <label for="deposit-txid-input">transaction id (tid)</label> <input type="text" id="deposit-txid-input" required> </div>
                <div class="btn-group"> <button type="button" class="btn btn-secondary" onclick="closeModalButton('deposit-modal')">cancel</button> <button type="submit" class="btn btn-primary">submit proof</button> </div>
            </form>
        </div>
    </div>
    <div id="withdraw-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('withdraw-modal')">×</button>
            <h3>request withdrawal</h3>
            <p>min: <strong id="withdraw-min-text">10</strong><strong> usdt</strong> | processing: <strong>~3 days</strong>.</p>
            <form id="withdraw-form" onsubmit="handleWithdrawSubmit(event)">
                <div class="form-group"> <label for="withdraw-amount-input">amount (usdt)</label> <input type="number" id="withdraw-amount-input" step="1" min="10" required> </div>
                <div class="form-group"> <label for="withdraw-method">method</label> <select id="withdraw-method" required> <option value="">-- select --</option> <option value="TRC20">TRC20</option> <option value="BEP20">BEP20</option> </select> </div>
                <div id="withdraw-account-fields"> <div class="form-group"> <label for="withdraw-account-number">your wallet address </label> <input type="text" id="withdraw-account-number" placeholder="You Wallet address " required> </div> </div>
                <div class="btn-group"> <button type="button" class="btn btn-secondary" onclick="showWithdrawHistory()">view history</button> <button type="submit" class="btn btn-primary">request</button> </div>
            </form>
            <div id="withdraw-history-section" style="display: none; margin-top: 20px;">
                <div class="table-responsive"><table><thead> <tr> <th>date</th> <th>amount (usdt)</th> <th>account</th> <th>status</th> </tr> </thead></table></div>
            </div>
        </div>
    </div>
    <div id="profile-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('profile-modal')">×</button>
            <h3>my profile</h3>
            <dl class="profile-info"> <dt>user id</dt> <dd id="profile-id">USR-123456789</dd> <dt>username</dt> <dd id="profile-username">[Username]</dd> <dt>email</dt> <dd id="profile-email">user@example.com</dd> </dl>
            <div style="text-align: right; margin-top: 20px;"> <button type="button" class="btn btn-primary" onclick="closeModalButton('profile-modal')">close</button> </div>
        </div>
    </div>
    <div id="notifications-modal" class="modal-overlay" onclick="closeModal(this, event)">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModalButton('notifications-modal')">×</button>
            <h3>Notifications</h3>
            <div id="notifications-list">
                <div class="no-notifications">You have no new notifications.</div>
            </div>
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModalButton('notifications-modal')">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
// ***************************************************************
const firebaseConfig = {
    apiKey: "AIzaSyD6Vq7sFI4gYAUjMXbE747T7bDUZE1a7V8",
    authDomain: "tmveb-f6461.firebaseapp.com",
    databaseURL: "https://tmveb-f6461-default-rtdb.firebaseio.com",
    projectId: "tmveb-f6461",
    storageBucket: "tmveb-f6461.firebasestorage.app",
    messagingSenderId: "658471205950",
    appId: "1:658471205950:web:c74823c649c6ce8029256f",
    measurementId: "G-9DVC401E1M"
};
// ***************************************************************

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- GLOBAL VARIABLES & DOM ELEMENTS ---
const authView = document.getElementById('auth-view');
const appView = document.getElementById('app-view');
const authCards = {
    'login-card': document.getElementById('login-card'),
    'signup-card': document.getElementById('signup-card'),
    'forgot-card': document.getElementById('forgot-card'),
};
const menuToggleBtn = document.getElementById('menu-toggle-btn');
const sidenav = document.getElementById('sidenav');
const sidenavOverlay = document.getElementById('sidenav-overlay');
const navLinks = document.querySelectorAll('.nav-link');
const contentPages = document.querySelectorAll('.content-page');
const sidenavLogoutBtn = document.getElementById('sidenav-logout');
let unsubscribeNotifications = null;
let transactionSettings = { minDeposit: 10, minWithdrawal: 10 };
let currentUserData = null; // Cache for current user data

// --- PAGE LOAD & AUTHENTICATION ---
document.addEventListener('DOMContentLoaded', () => {
    const params = new URLSearchParams(window.location.search);
    const refCode = params.get('ref');
    if (refCode) {
        showAuthPage('signup-card');
        const referralInput = document.getElementById('signup-referral');
        if (referralInput) {
            referralInput.value = refCode;
        }
    }
    document.querySelectorAll(".modal-overlay").forEach(e => e.style.display = "none");
    
    // **BACK BUTTON FIX**: Handle initial page load based on URL hash
    const initialPageId = window.location.hash.substring(1) || 'dashboard-page';
    handlePageNavigation(initialPageId);
});

// **BACK BUTTON FIX**: Listen for back/forward button clicks
window.onpopstate = function(event) {
    if (event.state && event.state.pageId) {
        handlePageNavigation(event.state.pageId, false); // Don't push a new state
    } else {
        // Fallback for initial page
        handlePageNavigation('dashboard-page', false);
    }
};

auth.onAuthStateChanged(user => {
    if (user) {
        db.collection('users').doc(user.uid).onSnapshot(doc => {
            if (doc.exists) {
                currentUserData = { id: doc.id, ...doc.data() };
                if (currentUserData.isBlocked === true) {
                    handleLogout();
                    setTimeout(() => alert('Your account has been blocked by an administrator.'), 200);
                    return;
                }
                if (unsubscribeNotifications) unsubscribeNotifications();
                displayUserInfo(currentUserData);
                fetchAndDisplayNotifications(user.uid);
                listenForTransactionSettings();
                
                const activePage = document.querySelector('.content-page.active').id;
                refreshPageContent(activePage);

                authView.style.display = 'none';
                appView.style.display = 'block';
            } else {
                handleLogout(); // User doc deleted from backend, log them out.
            }
        }, error => {
            console.error("Error fetching user data:", error);
            handleLogout();
        });
    } else {
        currentUserData = null;
        authView.style.display = 'flex';
        appView.style.display = 'none';
        showAuthPage('login-card');
        if (unsubscribeNotifications) unsubscribeNotifications();
    }
});


async function handleLogin(e) { e.preventDefault(); clearErrors(); const email = document.getElementById("login-email").value; const password = document.getElementById("login-password").value; const loginError = document.getElementById("login-error"); try { const userCredential = await auth.signInWithEmailAndPassword(email, password); const user = userCredential.user; const userDoc = await db.collection('users').doc(user.uid).get(); if (userDoc.exists && userDoc.data().isBlocked === true) { await auth.signOut(); loginError.textContent = 'This account is blocked. Please contact support.'; loginError.style.display = 'block'; } else { window.location.hash = 'dashboard-page'; } } catch (error) { console.error("Login Error:", error.code, error.message); loginError.textContent = 'Invalid email or password.'; loginError.style.display = 'block'; document.getElementById("login-email").classList.add("error"); document.getElementById("login-password").classList.add("error"); } }
async function handleSignup(e) { e.preventDefault(); clearErrors(); const t=document.getElementById("signup-username").value,n=document.getElementById("signup-email").value,o=document.getElementById("signup-password").value,a=document.getElementById("signup-referral").value,d=document.getElementById("signup-email-error"),s=document.getElementById("signup-password-error");if(o.length<6||o.length>12)return s.style.display="block",void document.getElementById("signup-password").classList.add("error");try{const e=await auth.createUserWithEmailAndPassword(n,o),r=e.user;await db.collection("users").doc(r.uid).set({uid:r.uid,username:t,email:n,balance:0,depositBalance:0,isBlocked:!1,referralCode:`REF-${t.toUpperCase()}${Math.floor(100+900*Math.random())}`,referredBy:a||null,totalEarning:0,todayEarning:0,lastWeekEarning:0,activePlanDailyAds:0,todayAdsWatched:0,watchedAdIdsToday:[],createdAt:firebase.firestore.FieldValue.serverTimestamp()}),alert("Signup successful! Please login."),document.getElementById("signup-form")?.reset(),showAuthPage('login-card')}catch(e){console.error("Signup Error:",e.code,e.message),"auth/email-already-in-use"===e.code?(d.style.display="block",document.getElementById("signup-email").classList.add("error")):alert("An error occurred during signup. Check the console for details.")}}
function handleLogout() { auth.signOut().then(() => { window.location.hash = ''; }).catch(e => console.error("Logout Error:", e)); }

// --- ADS & PLANS LOGIC (WITH FIXES) ---

async function fetchAndDisplayAds() {
    const container = document.getElementById("ads-container");
    if (!container || !currentUserData) return;

    container.innerHTML = "<p>Loading ads...</p>";

    try {
        const adsSnapshot = await db.collection("ads").get();
        if (adsSnapshot.empty) {
            container.innerHTML = '<div class="placeholder-content"><h3>No Ads Available</h3><p>Please check back later.</p></div>';
            return;
        }

        const planLimit = currentUserData.activePlanDailyAds || 0;
        const adsWatchedTodayCount = currentUserData.todayAdsWatched || 0;
        const watchedTodayIds = currentUserData.watchedAdIdsToday || [];
        const limitReached = adsWatchedTodayCount >= planLimit;

        let adsHtml = "";
        let availableAdsCount = 0;
        
        adsSnapshot.forEach(doc => {
            const ad = { id: doc.id, ...doc.data() };
            const isWatched = watchedTodayIds.includes(ad.id);
            
            // **FIX 2: Hide Watched Ads** - Only build the card if the ad is not watched.
            if (!isWatched) {
                availableAdsCount++;
                let buttonHtml;
                if (limitReached) {
                    buttonHtml = `<button class="btn-action" disabled>Daily Limit Reached</button>`;
                } else {
                    buttonHtml = `<button class="btn-action" id="ad-btn-${ad.id}" onclick="watchAd('${ad.id}', this)">Watch Ad</button>`;
                }

                adsHtml += `
                    <div class="ad-card">
                        <h3>${ad.title || "Ad"}</h3>
                        <p>${ad.description || "Watch this ad to earn a reward."}</p>
                        <div class="ad-details">
                             <div class="ad-detail-item">
                                <div class="label">REWARD</div>
                                <div class="value">${(ad.earning || 0).toFixed(2)} USDT</div>
                            </div>
                            <div class="ad-detail-item">
                                <div class="label">DURATION</div>
                                <div class="value">${ad.duration || 0} Sec</div>
                            </div>
                        </div>
                        ${buttonHtml}
                    </div>`;
            }
        });
        
        if (availableAdsCount === 0) {
            container.innerHTML = '<div class="placeholder-content"><h3>No More Ads for Today</h3><p>You have watched all available ads for today. Check back tomorrow!</p></div>';
        } else {
            container.innerHTML = adsHtml;
        }

    } catch (error) {
        console.error("Error fetching ads:", error);
        container.innerHTML = '<div class="placeholder-content"><h3>Error</h3><p>Could not load ads.</p></div>';
    }
}

async function watchAd(adId, buttonElement) {
    const user = auth.currentUser;
    if (!user) return;
    
    const adRef = db.collection('ads').doc(adId);
    const adDoc = await adRef.get();
    if (!adDoc.exists) return alert('Ad not found!');
    
    const adData = adDoc.data();
    const duration = adData.duration || 10;
    const earning = adData.earning || 0;

    buttonElement.disabled = true;
    const originalText = buttonElement.textContent;
    let countdown = duration;
    
    const interval = setInterval(() => {
        countdown--;
        buttonElement.textContent = `Watching... (${countdown}s)`;
        if (countdown <= 0) {
            clearInterval(interval);
        }
    }, 1000);

    if (adData.link) {
        window.open(adData.link, '_blank');
    }

    setTimeout(async () => {
        try {
            const userRef = db.collection('users').doc(user.uid);
            
            // **FIX 3: Earning Update Logic** - This logic is correct and robust.
            // It updates all relevant balances in a single, atomic transaction.
            // The `onSnapshot` listener on the user document will automatically
            // pick up these changes and reflect them on the dashboard in real-time.
            await db.runTransaction(async (transaction) => {
                const userDoc = await transaction.get(userRef);
                if (!userDoc.exists) throw "User not found!";
                
                // Use FieldValue.increment for safer concurrent updates
                const increment = firebase.firestore.FieldValue.increment(earning);
                
                transaction.update(userRef, {
                    balance: increment,
                    totalEarning: increment,
                    todayEarning: increment,
                    todayAdsWatched: firebase.firestore.FieldValue.increment(1),
                    watchedAdIdsToday: firebase.firestore.FieldValue.arrayUnion(adId)
                });
            });

            // The button and card will be removed on the next refresh of the page
            // which happens automatically due to the onSnapshot listener.
            await createNotification(user.uid, `You earned ${earning.toFixed(2)} USDT from watching an ad.`);

        } catch (error) {
            console.error("Transaction failed: ", error);
            alert("An error occurred while claiming your reward. Please try again.");
            buttonElement.textContent = originalText;
            buttonElement.disabled = false;
        }
    }, duration * 1000);
}


async function fetchAndDisplayPlans() { const container = document.getElementById("plans-container"); if (!container) return; container.innerHTML = "<p>Loading plans...</p>"; try { const plansSnapshot = await db.collection("plans").orderBy("price").get(); if (plansSnapshot.empty) { container.innerHTML = '<div class="placeholder-content"><h3>No Plans Available</h3><p>Please check back later.</p></div>'; return; } let plansHtml = ""; plansSnapshot.forEach(doc => { const plan = doc.data(); plansHtml += ` <div class="plan-card"> <h3>${plan.name || "Plan"}</h3> <div class="price">${plan.price || 0} USDT</div> <div class="plan-details"> <div class="plan-detail-item"><div class="label">Daily Earning</div><div class="value">${(plan.earning || 0).toFixed(2)}</div></div> <div class="plan-detail-item"><div class="label">Daily Ads</div><div class="value">${plan.dailyAds || 0}</div></div> <div class="plan-detail-item"><div class="label">Duration</div><div class="value">${plan.duration || 0} Days</div></div> </div> <button class="btn-action" onclick="investInPlan('${doc.id}', '${plan.name || "Plan"}', ${plan.price || 0}, ${plan.dailyAds || 0})">Invest Now</button> </div>`; }); container.innerHTML = plansHtml; } catch (error) { console.error("Error fetching plans:", error); container.innerHTML = '<div class="placeholder-content"><h3>Error</h3><p>Could not load plans.</p></div>'; } }
async function investInPlan(planId, planName, price, dailyAds) { const user = auth.currentUser; if (!user) return alert("Please login to invest in a plan."); if (confirm(`Are you sure you want to buy the "${planName}" plan for ${price} USDT? This amount will be deducted from your Deposit Balance.`)) { try { const userRef = db.collection("users").doc(user.uid); const userDoc = await userRef.get(); if (!userDoc.exists) return alert("Error: User data not found."); const userData = userDoc.data(); const depositBalance = userData.depositBalance || 0; if (depositBalance < price) { return alert("Insufficient deposit balance. Please add more funds to your deposit wallet to buy this plan."); } const newDepositBalance = depositBalance - price; const batch = db.batch(); batch.update(userRef, { depositBalance: newDepositBalance, activePlanId: planId, activePlanName: planName, activePlanDailyAds: dailyAds, planActivatedAt: firebase.firestore.FieldValue.serverTimestamp() }); const investmentRef = db.collection("investments").doc(); batch.set(investmentRef, { userId: user.uid, planId: planId, planName: planName, price: price, purchasedAt: firebase.firestore.FieldValue.serverTimestamp() }); await batch.commit(); await createNotification(user.uid, `Congratulations! You have successfully activated the "${planName}" plan.`); alert(`The "${planName}" plan has been activated successfully.`); } catch (error) { console.error("Error investing in plan:", error); alert("An error occurred while purchasing the plan. Please try again."); } } }


// --- UI & NAVIGATION (WITH BACK BUTTON FIX) ---
function displayUserInfo(userData) { if (!userData) return; document.getElementById("dashboard-main-balance").textContent=`${(userData.balance||0).toFixed(2)} Usdt`; document.getElementById("dashboard-deposit-balance").textContent=`${(userData.depositBalance||0).toFixed(2)} Usdt`; document.getElementById("dashboard-today-earning").textContent=`${(userData.todayEarning||0).toFixed(2)} Usdt`; document.getElementById("dashboard-last-week-earning").textContent=`${(userData.lastWeekEarning||0).toFixed(2)} Usdt`; document.getElementById("dashboard-total-earning").textContent=`${(userData.totalEarning||0).toFixed(2)} Usdt`; document.getElementById("profile-username").textContent=userData.username; document.getElementById("profile-email").textContent=userData.email; document.getElementById("profile-id").textContent=userData.uid; document.getElementById("page-referral-link").value = `${window.location.origin}${window.location.pathname}?ref=${userData.referralCode}`; }

function handlePageNavigation(pageId, pushState = true) {
    // Show the correct content page
    contentPages.forEach(p => p.classList.remove('active'));
    const page = document.getElementById(pageId);
    if (page) page.classList.add('active');

    // Update the active state of nav links
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (link.dataset.page === pageId) link.classList.add('active');
    });

    // Update header title
    const navLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
    if (navLink) document.querySelector(".header-brand").textContent = navLink.textContent.trim();

    // **BACK BUTTON FIX**: Update browser history
    if (pushState) {
        history.pushState({ pageId: pageId }, pageId, `#${pageId}`);
    }

    refreshPageContent(pageId);
    closeSidenav();
}

function refreshPageContent(pageId) { 
    if (!currentUserData) return; // Don't fetch if logged out
    if (pageId === 'ads-page') { fetchAndDisplayAds(); } 
    else if (pageId === 'plans-page') { fetchAndDisplayPlans(); } 
}

menuToggleBtn.addEventListener("click", () => sidenav.classList.add("open"));
sidenavOverlay.addEventListener("click", () => sidenav.classList.remove("open"));

// **BACK BUTTON FIX**: Use the new navigation function
navLinks.forEach(link => {
    link.addEventListener("click", (e) => {
        e.preventDefault();
        const pageId = link.dataset.page;
        handlePageNavigation(pageId);
    });
});
sidenavLogoutBtn.addEventListener("click", (e) => { e.preventDefault(); handleLogout(); });

function showAuthPage(cardId) {
    clearErrors();
    for (const id in authCards) {
        authCards[id].style.display = id === cardId ? 'block' : 'none';
    }
}

// --- OTHER UNCHANGED HELPER FUNCTIONS ---
async function createNotification(userId, message) { if (!userId || !message) return; try { await db.collection('notifications').add({ userId: userId, message: message, isRead: false, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); } catch (error) { console.error("Error creating notification:", error); } }
async function handleDepositSubmit(e) { e.preventDefault(); const user = auth.currentUser; if (!user) return alert("You are not logged in."); const form = document.getElementById("deposit-form"); const depositData = { userId: user.uid, email: user.email, method: document.getElementById("deposit-method-select").value, senderAddress: document.getElementById("deposit-account-number").value, amount: parseFloat(document.getElementById("deposit-amount-input").value), transactionId: document.getElementById("deposit-txid-input").value, status: "pending", createdAt: firebase.firestore.FieldValue.serverTimestamp() }; try { await db.collection("deposits").add(depositData); await createNotification(user.uid, `Your deposit request for ${depositData.amount} USDT has been submitted for review.`); alert("Deposit proof submitted! An admin will review it shortly."); closeModalButton("deposit-modal"); form.reset(); } catch (error) { console.error("Error submitting deposit:", error); alert("An error occurred. Please try again."); } }
async function handleWithdrawSubmit(e) { e.preventDefault(); const user = auth.currentUser; if (!user) return alert("You are not logged in."); const amount = parseFloat(document.getElementById("withdraw-amount-input").value); if (amount > parseFloat(document.getElementById("dashboard-main-balance").textContent.replace(" Usdt", ""))) { return alert("Withdrawal amount cannot be greater than your main balance!"); } const form = document.getElementById("withdraw-form"); const withdrawData = { userId: user.uid, email: user.email, amount: amount, method: document.getElementById("withdraw-method").value, walletAddress: document.getElementById("withdraw-account-number").value, status: "pending", createdAt: firebase.firestore.FieldValue.serverTimestamp() }; try { await db.collection("withdrawals").add(withdrawData); await createNotification(user.uid, `Your withdrawal request for ${withdrawData.amount} USDT is now pending.`); alert("Withdrawal requested! It will be processed by an admin."); closeModalButton("withdraw-modal"); form.reset(); } catch (error) { console.error("Error requesting withdrawal:", error); alert("An error occurred. Please try again."); } }
async function populateDepositWallets() { const container = document.getElementById('deposit-wallets-container'); container.innerHTML = '<p>Loading wallet addresses...</p>'; try { const snapshot = await db.collection('wallets').get(); if (snapshot.empty) { container.innerHTML = '<p>No deposit addresses are configured. Please contact support.</p>'; return; } let walletsHtml = ''; snapshot.forEach(doc => { const wallet = doc.data(); walletsHtml += `<div style="margin-bottom: 15px;"><strong style="color: var(--text-color-medium); font-size: 0.9em;">${wallet.name || 'Wallet'}</strong><br><code>${wallet.address || 'N/A'}</code><button onclick="copyToClipboard('${wallet.address}')" style="margin-left: 8px; font-size:0.75em; padding: 2px 5px; background: var(--border-color); border:none; border-radius: 4px; cursor: pointer;">copy</button></div>`; }); container.innerHTML = walletsHtml; } catch (error) { console.error("Error fetching deposit wallets:", error); container.innerHTML = '<p style="color: var(--danger-color);">Could not load wallet addresses. Please try again later.</p>'; } }
function listenForTransactionSettings() { db.collection('settings').doc('transactionLimits').onSnapshot(doc => { if (doc.exists) { const settings = doc.data(); transactionSettings.minDeposit = settings.minDeposit || 10; transactionSettings.minWithdrawal = settings.minWithdrawal || 10; } }, error => { console.error("Error listening to transaction settings:", error); }); }
function fetchAndDisplayNotifications(e){const t=document.getElementById("notifications-list"),n=document.getElementById("notification-badge");unsubscribeNotifications=db.collection("notifications").where("userId","==",e).orderBy("createdAt","desc").limit(20).onSnapshot(e=>{if(e.empty)return t.innerHTML='<div class="no-notifications">You have no new notifications.</div>',void(n.style.display="none");let o=0,a="";e.forEach(e=>{const t=e.data();t.isRead||o++;const n=(t.createdAt?.toDate().toLocaleString()||"just now");a+=`
<div class="notification-item">
<p>${t.message}</p>
<div class="timestamp">${n}</div>
</div>`}),t.innerHTML=a,n.style.display=o>0?"block":"none"})}
function clearErrors(){document.querySelectorAll("input.error").forEach(e=>e.classList.remove("error")),document.querySelectorAll(".error-message").forEach(e=>e.style.display="none")}
function closeSidenav(){sidenav.classList.remove("open"),sidenavOverlay.style.display="none"}
function openModal(modalId) { const modal = document.getElementById(modalId); if (modal) { modal.style.display = 'flex'; if (modalId === 'deposit-modal') { populateDepositWallets(); document.getElementById('deposit-min-text').textContent = transactionSettings.minDeposit; const depositInput = document.getElementById('deposit-amount-input'); depositInput.min = transactionSettings.minDeposit; depositInput.placeholder = `Minimum ${transactionSettings.minDeposit} USDT`; } if (modalId === 'withdraw-modal') { document.getElementById('withdraw-min-text').textContent = transactionSettings.minWithdrawal; const withdrawInput = document.getElementById('withdraw-amount-input'); withdrawInput.min = transactionSettings.minWithdrawal; withdrawInput.placeholder = `Minimum ${transactionSettings.minWithdrawal} USDT`; } if (modalId === 'notifications-modal' && auth.currentUser && document.getElementById('notification-badge').style.display === 'block') { db.collection("notifications").where("userId", "==", auth.currentUser.uid).where("isRead", "==", false).get().then(e => { const t = db.batch(); return e.docs.forEach(e => { t.update(e.ref, { isRead: true }) }), t.commit() }).catch(e => console.error("Error marking notifications as read:", e)) } } }
function closeModal(e,t){e===t.target&&(e.style.display="none")}function closeModalButton(e){const t=document.getElementById(e);t&&(t.style.display="none")}function showWithdrawHistory(){alert("Feature yah coming soon!")}function copyToClipboard(e){navigator.clipboard.writeText(e).then(()=>{alert("Copied!")}).catch(e=>{console.error("Copy failed: ",e),alert("Copy failed.")})}
</script>

</body>
</html>
