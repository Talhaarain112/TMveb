<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Pizza Earn</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* === PIZZA THEME STYLES === */
        :root {
            --primary-color: #ff6f00; /* Pizza Orange */
            --secondary-color: #d84315; /* Deep Red/Sauce */
            --background-color: #fff3e0; /* Light Dough color */
            --card-background: #ffffff;
            --text-color: #3e2723;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body { font-family: var(--font-family); margin: 0; background-color: var(--background-color); color: var(--text-color); }
        
        /* Views */
        .view-section { display: none; min-height: 100vh; padding: 20px; animation: fadeIn 0.4s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* General UI Elements */
        .card { background: var(--card-background); padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #ffe0b2; }
        .text-center { text-align: center; }
        .logo-area { text-align: center; margin-bottom: 30px; }
        .logo-area i { font-size: 60px; color: var(--primary-color); }
        .logo-area h1 { margin: 10px 0; color: var(--secondary-color); font-weight: 800; }

        /* Forms */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--secondary-color); }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #ffcc80; box-sizing: border-box; font-size: 16px; outline: none; }
        input:focus { border-color: var(--primary-color); }

        /* Buttons */
        .btn-main { width: 100%; padding: 15px; border: none; border-radius: 30px; background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 10px rgba(216, 67, 21, 0.3); }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; color: #666; }
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); margin-top: 10px; }
        .btn-copy { background: var(--secondary-color); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-top: 5px; }

        /* === PACKAGE PAGE === */
        .pkg-card { background: linear-gradient(135deg, #ff9800, #f57c00); color: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; text-align: center; cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden; }
        .pkg-card:hover { transform: translateY(-5px); }
        .pkg-card h3 { margin: 0; font-size: 24px; text-transform: uppercase; }
        .pkg-card .price { font-size: 28px; font-weight: bold; margin: 10px 0; background: rgba(255,255,255,0.2); padding: 5px; border-radius: 10px; }
        
        /* === DASHBOARD === */
        .dash-header { background: var(--secondary-color); color: white; padding: 20px; border-radius: 0 0 25px 25px; display: flex; align-items: center; justify-content: space-between; margin: -20px -20px 20px -20px; }
        .dash-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .dash-item { background: white; padding: 20px 10px; border-radius: 15px; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.05); cursor: pointer; border-bottom: 4px solid var(--primary-color); }
        .dash-item i { font-size: 28px; color: var(--secondary-color); margin-bottom: 10px; }
        .dash-item span { display: block; font-weight: bold; font-size: 14px; }

        /* === ADS === */
        .ad-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid var(--primary-color); }
        
        /* === HISTORY === */
        .history-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        
        /* Toast */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 1; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        .header-back { display: flex; align-items: center; gap: 10px; font-size: 20px; color: var(--text-color); margin-bottom: 20px; cursor: pointer; }
    </style>
</head>
<body>

    <!-- ================= AUTHENTICATION ================= -->
    <div id="auth-view" class="view-section">
        <div class="logo-area">
            <i class="fas fa-pizza-slice"></i>
            <h1>Pizza Earn</h1>
            <p>Delicious Profits</p>
        </div>

        <!-- Login Card -->
        <div id="login-card" class="card">
            <h2 class="text-center">Login</h2>
            <form id="login-form">
                <div class="form-group"><label>Email</label><input type="email" id="l-email" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="l-pass" required></div>
                <button type="submit" class="btn-main">Login</button>
            </form>
            <p class="text-center" style="margin-top:15px;">Don't have an account? <br><a href="#" onclick="toggleAuth('signup')" style="color:var(--secondary-color); font-weight:bold;">Register Now</a></p>
        </div>

        <!-- Signup Card -->
        <div id="signup-card" class="card" style="display:none;">
            <h2 class="text-center">Register</h2>
            <form id="signup-form">
                <div class="form-group"><label>Full Name</label><input type="text" id="s-name" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="s-email" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="s-pass" required></div>
                <div class="form-group">
                    <label>Referral Code (Required)</label>
                    <input type="text" id="s-ref" placeholder="Enter UID of Referrer" required>
                    <small style="color:red; font-size:11px;">* You cannot register without a referral code.</small>
                </div>
                <button type="submit" class="btn-main">Register & Next</button>
            </form>
            <p class="text-center" style="margin-top:15px;">Already have an account? <br><a href="#" onclick="toggleAuth('login')" style="color:var(--secondary-color); font-weight:bold;">Login</a></p>
        </div>
    </div>

    <!-- ================= SELECT PACKAGE ================= -->
    <div id="package-view" class="view-section">
        <div class="logo-area">
            <h2>Select Package</h2>
            <p>Choose your Pizza Size</p>
        </div>
        
        <div class="pkg-card" onclick="selectPackage('Small Pizza', 700)">
            <i class="fas fa-cookie-bite" style="font-size:40px; margin-bottom:10px;"></i>
            <h3>Small Pizza</h3>
            <div class="price">700 Rs</div>
            <p>Daily 10 Ads</p>
        </div>

        <div class="pkg-card" onclick="selectPackage('Medium Pizza', 1400)">
            <i class="fas fa-pizza-slice" style="font-size:40px; margin-bottom:10px;"></i>
            <h3>Medium Pizza</h3>
            <div class="price">1,400 Rs</div>
            <p>Daily 10 Ads</p>
        </div>

        <div class="pkg-card" onclick="selectPackage('Large Pizza', 2000)">
            <i class="fas fa-utensils" style="font-size:40px; margin-bottom:10px;"></i>
            <h3>Large Pizza</h3>
            <div class="price">2,000 Rs</div>
            <p>Daily 10 Ads</p>
        </div>
        
        <button class="btn-main btn-outline" onclick="firebase.auth().signOut()">Logout</button>
    </div>

    <!-- ================= PAYMENT VERIFICATION ================= -->
    <div id="payment-view" class="view-section">
        <div class="logo-area">
            <h2>Confirm Payment</h2>
            <p id="selected-pkg-name" style="color:var(--primary-color); font-weight:bold;">...</p>
        </div>
        
        <div class="card">
            <div class="text-center" style="background:#eee; padding:10px; border-radius:8px; margin-bottom:15px;">
                <p style="margin:0; font-size:12px;">Please send <b id="pay-amount">0</b> Rs to:</p>
                <h3 style="margin:5px 0;">03023317462</h3>
                <p style="margin:0;">MUBEEN KESAR (JAZZCASH)</p>
            </div>

            <form id="payment-form">
                <div class="form-group">
                    <label>Sender Number</label>
                    <input type="number" id="pay-number" placeholder="03XXXXXXXXX" required>
                </div>
                <div class="form-group">
                    <label>Sender Name</label>
                    <input type="text" id="pay-name" placeholder="Account Holder Name" required>
                </div>
                <div class="form-group">
                    <label>Trx ID (Transaction ID)</label>
                    <input type="text" id="pay-trx" placeholder="e.g. 8273..." required>
                </div>
                <button type="submit" class="btn-main">Submit</button>
            </form>
            <button class="btn-main btn-outline" onclick="showView('package-view')">Back to Packages</button>
        </div>
    </div>

    <!-- ================= PENDING / REJECTED SCREEN ================= -->
    <div id="status-view" class="view-section">
        <div class="card text-center" style="margin-top: 50px;">
            <i id="status-icon" class="fas fa-clock" style="font-size: 60px; color: #ff9800;"></i>
            <h2 id="status-title" style="margin-top: 20px;">Verification Pending</h2>
            <p id="status-msg">Please wait for 24 hours while Admin verifies your payment.</p>
            
            <div id="rejected-actions" style="display:none;">
                <button class="btn-main" onclick="showView('payment-view')">Submit Details Again</button>
            </div>
            
            <button class="btn-main btn-outline" onclick="firebase.auth().signOut()">Logout</button>
        </div>
    </div>

    <!-- ================= DASHBOARD ================= -->
    <div id="dashboard-view" class="view-section">
        <div class="dash-header">
            <div>
                <h3 style="margin:0;">Pizza Earn</h3>
                <small id="u-name">User</small>
            </div>
            <div style="text-align:right;">
                <h2 style="margin:0;" id="u-bal">0.00 Rs</h2>
                <small>Balance</small>
            </div>
        </div>

        <div class="dash-grid">
            <div class="dash-item" onclick="openSubPage('ads-page')">
                <i class="fas fa-play-circle"></i>
                <span>Ads</span>
            </div>
            <div class="dash-item" onclick="openSubPage('profile-page')">
                <i class="fas fa-user-circle"></i>
                <span>Profile</span>
            </div>
            <div class="dash-item" onclick="openSubPage('wallet-page')">
                <i class="fas fa-wallet"></i>
                <span>Wallet</span>
            </div>
            <div class="dash-item" onclick="openSubPage('team-page')">
                <i class="fas fa-users"></i>
                <span>Team</span>
            </div>
            <div class="dash-item" onclick="openSubPage('settings-page')">
                <i class="fas fa-cogs"></i>
                <span>Setting</span>
            </div>
            <div class="dash-item" onclick="openSubPage('support-page')">
                <i class="fas fa-headset"></i>
                <span>Support</span>
            </div>
        </div>
        <button class="btn-main btn-outline" onclick="firebase.auth().signOut()" style="margin-top:30px; border-color:red; color:red;">Logout</button>
    </div>

    <!-- ===== SUB PAGES ===== -->
    
    <!-- 1. ADS PAGE -->
    <div id="ads-page" class="view-section">
        <div class="header-back" onclick="showView('dashboard-view')"><i class="fas fa-arrow-left"></i> Daily Ads</div>
        <div class="card">
            <p class="text-center">Watched: <b id="ads-count">0</b>/10</p>
            <div id="ads-loader" class="text-center" style="display:none;">Calculating Earnings...</div>
            <div id="ads-list">Loading...</div>
        </div>
    </div>

    <!-- 2. PROFILE PAGE -->
    <div id="profile-page" class="view-section">
        <div class="header-back" onclick="showView('dashboard-view')"><i class="fas fa-arrow-left"></i> Profile</div>
        <div class="card">
            <h3>Change Password</h3>
            <form id="pass-change-form">
                <div class="form-group"><label>Current Password</label><input type="password" id="old-pass" required></div>
                <div class="form-group"><label>New Password</label><input type="password" id="new-pass" required></div>
                <button type="submit" class="btn-main">Update Password</button>
            </form>
        </div>
    </div>

    <!-- 3. WALLET PAGE -->
    <div id="wallet-page" class="view-section">
        <div class="header-back" onclick="showView('dashboard-view')"><i class="fas fa-arrow-left"></i> Wallet</div>
        <div class="card text-center">
            <h1><span id="w-bal">0.00</span> Rs</h1>
            <p>Available Balance</p>
            <hr>
            <h3>Withdraw Funds</h3>
            <p id="bank-info-display" style="font-size:14px; color:#666; margin-bottom:10px;">
                <!-- Banking info loads here -->
            </p>
            <form id="withdraw-form">
                <input type="number" id="with-amount" placeholder="Amount (Min 300)" required style="margin-bottom:10px;">
                <button type="submit" class="btn-main">Add to Bank Account</button>
            </form>
        </div>
        <div class="card">
            <h3>History</h3>
            <div id="with-history">Loading...</div>
        </div>
    </div>

    <!-- 4. TEAM PAGE -->
    <div id="team-page" class="view-section">
        <div class="header-back" onclick="showView('dashboard-view')"><i class="fas fa-arrow-left"></i> My Team</div>
        <div class="card text-center">
            <p>Your Referral Link (Share this):</p>
            <div id="my-ref-container" style="background:#eee; padding:10px; border-radius:8px;">
                Loading...
            </div>
            <p style="font-size:12px; margin-top:5px; color:red;">Refer & Earn Weekly Boosts!</p>
        </div>
        <div class="card">
            <h3>Referrals</h3>
            <div id="team-list">Loading...</div>
        </div>
    </div>

    <!-- 5. SETTINGS PAGE -->
    <div id="settings-page" class="view-section">
        <div class="header-back" onclick="showView('dashboard-view')"><i class="fas fa-arrow-left"></i> Settings</div>
        <div class="card">
            <h3>Payment Details</h3>
            <p style="font-size:12px; color:gray;">This is where you receive withdrawals.</p>
            <form id="settings-form">
                <div class="form-group">
                    <label>Account Provider</label>
                    <select id="set-provider">
                        <option value="Easypaisa">Easypaisa</option>
                        <option value="Jazzcash">Jazzcash</option>
                    </select>
                </div>
                <div class="form-group"><label>Account Number</label><input type="number" id="set-number" required></div>
                <div class="form-group"><label>Account Holder Name</label><input type="text" id="set-name" required></div>
                <button type="submit" class="btn-main">Save / Update</button>
            </form>
        </div>
    </div>

    <!-- 6. SUPPORT PAGE -->
    <div id="support-page" class="view-section">
        <div class="header-back" onclick="showView('dashboard-view')"><i class="fas fa-arrow-left"></i> Support</div>
        <div class="dash-grid">
            <a href="https://wa.me/03023317462" target="_blank" class="dash-item" style="text-decoration:none; color:inherit;">
                <i class="fab fa-whatsapp" style="color:#25D366;"></i>
                <span>WhatsApp</span>
            </a>
            <a href="https://t.me/pizzaearn" target="_blank" class="dash-item" style="text-decoration:none; color:inherit;">
                <i class="fab fa-telegram" style="color:#0088cc;"></i>
                <span>Telegram</span>
            </a>
            <a href="https://tiktok.com/@talhaarain4220" target="_blank" class="dash-item" style="text-decoration:none; color:inherit;">
                <i class="fab fa-tiktok" style="color:#000;"></i>
                <span>TikTok</span>
            </a>
        </div>
    </div>

    <div id="toast">Message</div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // === FIREBASE CONFIGURATION ===
        const firebaseConfig = {
            apiKey: "AIzaSyDoT8uTKQUcP0mTwFylms9co_0F8y_Kab8", 
            authDomain: "my-project-9d47d.firebaseapp.com",
            projectId: "my-project-9d47d",
            storageBucket: "my-project-9d47d.firebasestorage.app",
            messagingSenderId: "324265197507",
            appId: "1:324265197507:web:f2a895e00bf3cfaf084776"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = null;

        // === ON LOAD: CHECK REFERRAL LINK ===
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const refParam = urlParams.get('ref');
            if(refParam) {
                setTimeout(() => {
                    if(!currentUser) {
                        showView('auth-view');
                        toggleAuth('signup');
                        document.getElementById('s-ref').value = refParam;
                        document.getElementById('s-ref').readOnly = true;
                    }
                }, 1000);
            }
        });

        // === NAVIGATION ===
        function showView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');

            const avoidSaving = ['auth-view', 'package-view', 'payment-view', 'status-view'];
            if (!avoidSaving.includes(viewId)) {
                localStorage.setItem('savedPage', viewId);
            }
        }

        function toggleAuth(type) {
            document.getElementById('login-card').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('signup-card').style.display = type === 'signup' ? 'block' : 'none';
        }

        function openSubPage(pageId) {
            showView(pageId);
            if(pageId === 'ads-page') loadAds();
            if(pageId === 'wallet-page') loadWallet();
            if(pageId === 'team-page') loadTeam();
            if(pageId === 'settings-page') loadSettings();
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // === AUTH LOGIC ===
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                db.collection('users').doc(user.uid).onSnapshot(doc => {
                    if (doc.exists) {
                        userData = doc.data();
                        handleUserStatus();
                    }
                });
            } else {
                localStorage.removeItem('savedPage');
                showView('auth-view');
                const urlParams = new URLSearchParams(window.location.search);
                if(!urlParams.get('ref')){
                    toggleAuth('login'); 
                }
            }
        });

        function handleUserStatus() {
            // ---> NAYA CODE: Block Check <---
            if (userData.isBlocked) {
                alert("Your account has been blocked by Admin. Contact Support.");
                firebase.auth().signOut();
                return;
            }
            // ---------------------------------

            if (!userData.package) {
                showView('package-view');
            } 
            else if (userData.status === 'pending') {
                showView('status-view');
                document.getElementById('status-title').innerText = "Wait for 24 hours";
                document.getElementById('status-msg').innerText = "Your payment is under review.";
                document.getElementById('status-icon').className = "fas fa-clock";
                document.getElementById('status-icon').style.color = "#ff9800";
                document.getElementById('rejected-actions').style.display = "none";
            } 
            else if (userData.status === 'rejected') {
                showView('status-view');
                document.getElementById('status-title').innerText = "Registration Rejected";
                document.getElementById('status-msg').innerText = "Admin rejected your payment. Please check details.";
                document.getElementById('status-icon').className = "fas fa-times-circle";
                document.getElementById('status-icon').style.color = "red";
                document.getElementById('rejected-actions').style.display = "block";
            } 
            else if (userData.status === 'approved') {
                updateDashboardUI();
                const savedPage = localStorage.getItem('savedPage');
                if (savedPage) {
                    if (savedPage === 'ads-page') loadAds();
                    if (savedPage === 'wallet-page') loadWallet();
                    if (savedPage === 'team-page') loadTeam();
                    if (savedPage === 'settings-page') loadSettings();
                    showView(savedPage);
                } else {
                    showView('dashboard-view');
                }
            }
        }

        // Registration Logic
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('s-email').value;
            const pass = document.getElementById('s-pass').value;
            const name = document.getElementById('s-name').value;
            const refCode = document.getElementById('s-ref').value.trim();

            if (!refCode) { showToast("Referral Code is required!"); return; }

            try {
                const refCheck = await db.collection('users').doc(refCode).get();
                if (!refCheck.exists) { showToast("Invalid Referral Code!"); return; }

                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection('users').doc(cred.user.uid).set({
                    uid: cred.user.uid,
                    name: name,
                    email: email,
                    balance: 0,
                    referredBy: refCode,
                    status: 'new',
                    joinDate: firebase.firestore.FieldValue.serverTimestamp(),
                    adsWatchedToday: 0,
                    lastAdDate: null
                });
            } catch (error) {
                showToast(error.message);
            }
        });

        // Login
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('l-email').value;
            const pass = document.getElementById('l-pass').value;
            
            auth.signInWithEmailAndPassword(email, pass).catch(err => {
                if (err.code === 'auth/invalid-login-credentials' || 
                    err.code === 'auth/wrong-password' || 
                    err.code === 'auth/user-not-found' ||
                    err.message.includes('INVALID_LOGIN_CREDENTIALS')) {
                    showToast("Incorrect Email or Password!");
                } else {
                    showToast("Login failed! Please check your connection.");
                }
            });
        });

        // === PACKAGE & PAYMENT ===
        let tempPackage = {};

        function selectPackage(name, price) {
            tempPackage = { name, price };
            document.getElementById('selected-pkg-name').innerText = name + " - " + price + " Rs";
            document.getElementById('pay-amount').innerText = price;
            showView('payment-view');
        }

        document.getElementById('payment-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const senderNum = document.getElementById('pay-number').value;
            const senderName = document.getElementById('pay-name').value;
            const trxId = document.getElementById('pay-trx').value;

            db.collection('users').doc(currentUser.uid).update({
                package: tempPackage.name,
                packagePrice: tempPackage.price,
                paymentDetails: {
                    senderNumber: senderNum,
                    senderName: senderName,
                    trxId: trxId
                },
                status: 'pending'
            }).then(() => {
                showToast("Submitted!");
            });
        });

        // === DASHBOARD LOGIC ===
        function updateDashboardUI() {
            document.getElementById('u-name').innerText = userData.name;
            document.getElementById('u-bal').innerText = userData.balance.toFixed(2) + " Rs";
            
            const baseUrl = window.location.origin + window.location.pathname;
            const refLink = `${baseUrl}?ref=${currentUser.uid}`;
            
            document.getElementById('my-ref-container').innerHTML = `
                <input type="text" value="${refLink}" id="ref-input" readonly style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px; font-size:12px;">
                <button class="btn-copy" onclick="copyRef()">Copy Link</button>
            `;
        }
        
        function copyRef() {
            const copyText = document.getElementById("ref-input");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(copyText.value).then(() => {
                showToast("Link Copied!");
            });
        }

        // === 1. ADS (With Referral Boost Logic & Timer) ===
        async function loadAds() {
            const list = document.getElementById('ads-list');
            const loader = document.getElementById('ads-loader');
            
            list.innerHTML = "";
            loader.style.display = "block";
            
            const today = new Date().toDateString();
            let watched = 0;
            if(userData.lastAdDate === today) {
                watched = userData.adsWatchedToday || 0;
            }
            document.getElementById('ads-count').innerText = watched;

            if(watched >= 10) {
                loader.style.display = "none";
                list.innerHTML = "<p class='text-center'>Daily Limit Reached (10/10)</p>";
                return;
            }

            let baseRate = 0;
            const joinDate = userData.joinDate ? userData.joinDate.toDate() : new Date();
            const now = new Date();
            const diffTime = Math.abs(now - joinDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            const pkg = userData.package;
            if(pkg === 'Small Pizza') {
                if(diffDays <= 7) baseRate = 3;
                else if(diffDays <= 14) baseRate = 1;
                else baseRate = 0.1;
            } else if(pkg === 'Medium Pizza') {
                if(diffDays <= 7) baseRate = 5;
                else if(diffDays <= 14) baseRate = 2;
                else if(diffDays <= 21) baseRate = 1;
                else baseRate = 0.1;
            } else if(pkg === 'Large Pizza') {
                if(diffDays <= 7) baseRate = 7;
                else if(diffDays <= 14) baseRate = 3;
                else if(diffDays <= 21) baseRate = 1;
                else baseRate = 0.1;
            }

            let boostAmount = 0;
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            try {
                const snapshot = await db.collection('users')
                    .where('referredBy', '==', currentUser.uid)
                    .where('status', '==', 'approved')
                    .get();

                snapshot.forEach(doc => {
                    const refUser = doc.data();
                    const refDate = refUser.approvedAt ? refUser.approvedAt.toDate() : (refUser.joinDate ? refUser.joinDate.toDate() : null);
                    
                    if (refDate && refDate > sevenDaysAgo) {
                        if (refUser.package === 'Small Pizza') boostAmount += 2;
                        if (refUser.package === 'Medium Pizza') boostAmount += 3;
                        if (refUser.package === 'Large Pizza') boostAmount += 5;
                    }
                });
            } catch (e) {
                console.error("Boost Error:", e);
            }

            const finalRate = baseRate + boostAmount;
            
            loader.style.display = "none";
            for(let i=1; i<=10; i++) {
                if(i > watched) {
                    const div = document.createElement('div');
                    div.className = 'ad-row';
                    div.innerHTML = `
                        <div>
                            <b>Ad #${i}</b> <br> 
                            <small>Base: ${baseRate} + Boost: ${boostAmount} = <b>${finalRate} Rs</b></small>
                        </div>
                        <button class="btn-main" style="width:auto; padding:5px 15px; font-size:12px;" onclick="watchAd(${finalRate}, this)">Watch</button>
                    `;
                    list.appendChild(div);
                }
            }
        }

        function watchAd(amount, btn) {
            // 1. Link jo new tab mein khulega (Aap isay YouTube link ya kisi bhi website se change kar sakte hain)
            const adUrl = "https://paklivepslmatch.blogspot.com/2025/06/breaking-internet-latest-viral-news-you.html";
            window.open(adUrl, "_blank");

            // 2. Button disable karna aur timer shuru karna
            btn.disabled = true;
            let timeLeft = 10;
            btn.innerText = `Wait ${timeLeft}s...`;

            const timer = setInterval(() => {
                timeLeft--;
                if(timeLeft > 0) {
                    btn.innerText = `Wait ${timeLeft}s...`;
                } else {
                    clearInterval(timer);
                    btn.innerText = "Processing...";

                    // 3. Database mein balance add karna
                    const today = new Date().toDateString();
                    const batch = db.batch();
                    const userRef = db.collection('users').doc(currentUser.uid);
                    
                    if(userData.lastAdDate !== today) {
                        batch.update(userRef, { 
                            balance: firebase.firestore.FieldValue.increment(amount),
                            lastAdDate: today,
                            adsWatchedToday: 1
                        });
                    } else {
                        batch.update(userRef, { 
                            balance: firebase.firestore.FieldValue.increment(amount),
                            adsWatchedToday: firebase.firestore.FieldValue.increment(1)
                        });
                    }
                    
                    batch.commit().then(() => {
                        showToast(`Earned ${amount} Rs`);
                        btn.innerText = "Completed";
                        btn.style.background = "#28a745"; // Make it green after complete
                    });
                }
            }, 1000); // 1000ms = 1 second
        }

        // 2. PROFILE (Password Change)
        document.getElementById('pass-change-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const oldPass = document.getElementById('old-pass').value;
            const newPass = document.getElementById('new-pass').value;
            
            const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, oldPass);
            currentUser.reauthenticateWithCredential(cred).then(() => {
                currentUser.updatePassword(newPass).then(() => {
                    showToast("Password Updated!");
                    document.getElementById('pass-change-form').reset();
                });
            }).catch(err => showToast("Incorrect Old Password"));
        });

        // 3. WALLET & 5. SETTINGS
        function loadSettings() {
            if(userData.banking) {
                document.getElementById('set-provider').value = userData.banking.provider;
                document.getElementById('set-number').value = userData.banking.number;
                document.getElementById('set-name').value = userData.banking.name;
            }
        }

        document.getElementById('settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const data = {
                provider: document.getElementById('set-provider').value,
                number: document.getElementById('set-number').value,
                name: document.getElementById('set-name').value
            };
            db.collection('users').doc(currentUser.uid).update({ banking: data })
            .then(() => showToast("Details Saved!"));
        });

        function loadWallet() {
            document.getElementById('w-bal').innerText = userData.balance.toFixed(2);
            if(userData.banking) {
                document.getElementById('bank-info-display').innerText = `Sending to: ${userData.banking.provider} (${userData.banking.number})`;
            } else {
                document.getElementById('bank-info-display').innerText = "Please set up Banking Details in Settings first.";
            }

            // Load History with Date
            db.collection('withdrawals').where('uid', '==', currentUser.uid).get().then(snap => {
                const list = document.getElementById('with-history');
                if(snap.empty) { list.innerHTML = "No history"; return; }
                let html = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    let displayStatus = d.status;
                    let color = 'orange';
                    
                    if(d.status === 'sent') {
                        displayStatus = 'Approved';
                        color = 'green';
                    } else if (d.status === 'rejected') {
                        color = 'red';
                    }
                    
                    // Formatting Date
                    let dateStr = "Pending...";
                    if(d.date) {
                        let dateObj = d.date.toDate ? d.date.toDate() : new Date(d.date);
                        dateStr = dateObj.toLocaleDateString() + " " + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }

                    html += `
                        <div class="history-item">
                            <div>
                                <span style="font-weight:bold; font-size:16px;">${d.amount} Rs</span><br>
                                <span style="font-size:11px; color:#888;">${dateStr}</span>
                            </div>
                            <span style="color:${color}; font-weight:bold;">${displayStatus.toUpperCase()}</span>
                        </div>`;
                });
                list.innerHTML = html;
            });
        }

        document.getElementById('withdraw-form').addEventListener('submit', (e) => {
            e.preventDefault();
            if(!userData.banking) { showToast("Go to Settings and save account details first!"); return; }
            
            const amount = parseFloat(document.getElementById('with-amount').value);
            if(amount < 300) { showToast("Minimum withdrawal is 300 Rs"); return; }
            if(userData.balance < amount) { showToast("Insufficient Balance"); return; }
            
            db.collection('withdrawals').add({
                uid: currentUser.uid,
                amount: amount,
                details: userData.banking,
                status: 'pending',
                date: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                db.collection('users').doc(currentUser.uid).update({
                    balance: firebase.firestore.FieldValue.increment(-amount)
                });
                showToast("Withdrawal Requested");
                document.getElementById('withdraw-form').reset();
                loadWallet();
            });
        });

        // 4. TEAM
        function loadTeam() {
            const list = document.getElementById('team-list');
            db.collection('users').where('referredBy', '==', currentUser.uid).get().then(snap => {
                if(snap.empty) { list.innerHTML = "No referrals yet."; return; }
                let html = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    let color = d.status === 'approved' ? 'green' : 'orange';
                    html += `<div class="history-item">
                        <div><b>${d.name}</b><br><small>${d.package || 'No Plan'}</small></div>
                        <div style="color:${color}; font-weight:bold;">${d.status.toUpperCase()}</div>
                    </div>`;
                });
                list.innerHTML = html;
            });
        }
    </script>
</body>
</html>
